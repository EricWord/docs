[TOC]

# 1. 需求分析及实现思路

## 1.1 分层需求分析

![image-20210525154149910](images/image-20210525154149910.png)

![image-20210525154645709](images/image-20210525154645709.png)

## 1.2 每层的职能

![image-20210525155119576](images/image-20210525155119576.png)

![image-20210525155137437](images/image-20210525155137437.png)

![image-20210525155304123](images/image-20210525155304123.png)

## 1.3 DWD层数据准备实现思路

# 2.环境搭建

## 2.1 在工程中新建模块gmall2021-realtime

![image-20210525161138667](images/image-20210525161138667.png)

## 2.2 创建如下包结构

![image-20210525161343018](images/image-20210525161343018.png)

![image-20210525161738114](images/image-20210525161738114.png)



## 2.3 修改配置文件

### 2.3.1 在pom.xml添加如下配置

![image-20210525161443867](images/image-20210525161443867.png)

### 2.3.2  在resources目录下创建log4j.properties配置文件

![image-20210525161923827](images/image-20210525161923827.png)

# 3.准备用户行为日志DWD层

![image-20210525162133654](images/image-20210525162133654.png)

## 3.1 主要任务

### 3.1.1 识别新老用户

![image-20210525162850653](images/image-20210525162850653.png)

### 3.1.2 利用侧输出流实现数据拆分

![image-20210525162900946](images/image-20210525162900946.png)



### 3.1.3 将不同流的数据推送到下游的kafka



## 3.2 代码实现



### 3.2.1 接收kafka数据，并进行转换

1. 封装操作kafka的工具类，并提供获取kafka消费者的方法(读)



### 3.2.2 识别新老访客

![image-20210525170914243](images/image-20210525170914243.png)

### 3.2.3 利用侧输出流实现数据拆分

![image-20210525174411622](images/image-20210525174411622.png)



### 3.2.4 将不同流的数据推送到下游kafka





# 4. 准备业务数据DWD层

![image-20210525204204179](images/image-20210525204204179.png)

## 4.1 主要任务

### 4.1.1 接收kafka数据，过滤空值数据

对Maxwell抓取数据进行ETL,有用的部分保留，没用的过滤掉

### 4.1.2 实现动态分流功能

![image-20210525205110927](images/image-20210525205110927.png)

![image-20210525205311456](images/image-20210525205311456.png)

![image-20210525205736367](images/image-20210525205736367.png)

![image-20210525210212712](images/image-20210525210212712.png)

该看44





### 4.1.3 把分好的流保存到对应表、主题中

![image-20210525210156524](images/image-20210525210156524.png)



## 4.2 代码实现

### 4.2.1 接收kafka数据，过滤空值数据

![image-20210526165319132](images/image-20210526165319132.png)



### 4.2.2 根据MySQL的配置表，动态进行分流

![image-20210526171640854](images/image-20210526171640854.png)

![image-20210526172123926](images/image-20210526172123926.png)

![image-20210526194347248](images/image-20210526194347248.png)

# 5. 总结



